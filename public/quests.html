<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quest Board â€¢ Adventurers Guild</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="guild-header">
    <h1>ðŸ“œ Quest Board</h1>
    <p>Current missions for brave souls of the realm.</p>
  </header>

  <main class="guild-main">
    <section class="quest-list">
      <!-- Quest list will be populated by JavaScript from /api/quests -->
      <div id="quests-container">
        <p>Loading questsâ€¦</p>
      </div>
    </section>
  </main>

  <section class="application">
    <h3>Apply to join the Guild</h3>
    <form id="application-form">
      <input name="email" type="email" placeholder="Email" required />
      <input name="full_name" placeholder="Full name" />
      <label>Skills (comma separated)</label>
      <textarea name="skills" placeholder="List your skills"></textarea>
      <label>Qualities / checklist</label>
      <textarea name="qualities" placeholder="Your qualities, experience, availability"></textarea>
      <label>Additional information</label>
      <textarea name="additional_info" placeholder="Anything else to help your application"></textarea>
      <button type="submit" id="application-submit-quests">Submit Application</button>
    </form>
    <p id="application-result"></p>
  </section>

  <footer class="guild-footer">
    <p>Return to <a href="/">Guild Hall</a></p>
  </footer>

  <script>
    async function loadQuests() {
      const container = document.getElementById('quests-container');
      try {
        const res = await fetch('/api/quests/');
        if (!res.ok) throw new Error('Network response was not ok: ' + res.status);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<p>No quests available right now.</p>';
          return;
        }
        container.innerHTML = data.map(q => `
          <article class="quest">
            <h2>${q.title}</h2>
            <p><strong>Location:</strong> ${q.location || 'Unknown'}</p>
            <p><strong>Reward:</strong> ${q.reward || 'TBD'}</p>
            <p><strong>Status:</strong> ${q.status}</p>
            <p>${q.description || ''}</p>
            <p class="meta">Posted by: ${q.posted_by || 'Anonymous'} â€” ${new Date(q.created_at).toLocaleString()}</p>
          </article>
        `).join('');
      } catch (err) {
        console.error('Error loading quests:', err);
        container.innerHTML = '<p>Error loading quests. Try again later.</p>';
      }
    }
    document.addEventListener('DOMContentLoaded', loadQuests);
  </script>

  <section class="auth">
    <h3>Member login</h3>
    <form id="login-form">
      <input name="username" placeholder="username" required />
      <input name="password" type="password" placeholder="password" required />
      <button type="submit">Log in</button>
    </form>
    <p id="login-result"></p>

    <h3>Post a Quest (authenticated)</h3>
    <form id="post-quest-form">
      <input name="title" placeholder="Title" required />
      <input name="location" placeholder="Location" />
      <input name="reward" placeholder="Reward" />
      <textarea name="description" placeholder="Description"></textarea>
      <button type="submit">Post Quest</button>
    </form>
    <p id="post-result"></p>
  </section>

  <script>
    // Login form handler - obtain token
    document.getElementById('login-form').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const f = ev.target;
      const creds = { username: f.username.value, password: f.password.value };
      const resEl = document.getElementById('login-result');
      try {
        const res = await fetch('/api-token-auth/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(creds)
        });
        if (!res.ok) throw new Error('Login failed: ' + res.status);
        const data = await res.json();
        localStorage.setItem('apiToken', data.token);
        resEl.textContent = 'Logged in successfully.';
      } catch (err) {
        console.error('Login error', err);
        resEl.textContent = 'Login failed.';
      }
    });

    // Post quest form handler
    document.getElementById('post-quest-form').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const f = ev.target;
      const token = localStorage.getItem('apiToken');
      const body = {
        title: f.title.value,
        location: f.location.value,
        reward: f.reward.value,
        description: f.description.value,
      };
      const resEl = document.getElementById('post-result');
      try {
        const res = await fetch('/api/quests/', {
          method: 'POST',
          headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': 'Token ' + token } : {}),
          body: JSON.stringify(body)
        });
        if (res.status === 401 || res.status === 403) {
          resEl.textContent = 'You must be logged in to post a quest.';
          return;
        }
        if (!res.ok) throw new Error('Post failed: ' + res.status);
        const data = await res.json();
        resEl.textContent = 'Quest posted.';
        // Refresh the list
        loadQuests();
      } catch (err) {
        console.error('Post error', err);
        resEl.textContent = 'Error posting quest.';
      }
    });
    // Application form handler with UI polish and client-side cooldown
    (function(){
      const form = document.getElementById('application-form');
      const submitBtn = document.getElementById('application-submit-quests');
      const resEl = document.getElementById('application-result');
      let cooldown = false;

      function showMessage(text, ok){
        resEl.className = 'form-message ' + (ok ? 'success' : 'error');
        resEl.textContent = text;
      }

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        if (cooldown) return showMessage('Please wait before submitting another application.', false);
        const f = ev.target;
        if (!f.email.value) return showMessage('Please enter an email.', false);
        submitBtn.classList.add('btn-disabled');
        submitBtn.disabled = true;
        const body = {
          email: f.email.value,
          full_name: f.full_name.value,
          skills: f.skills.value,
          qualities: f.qualities.value,
          additional_info: f.additional_info.value,
        };
        try {
          const res = await fetch('/api/applications/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || res.statusText || 'Application submission failed');
          }
          showMessage('Application submitted. You will be notified after review.', true);
          f.reset();
          cooldown = true;
          setTimeout(() => { cooldown = false; submitBtn.classList.remove('btn-disabled'); submitBtn.disabled = false; }, 30000);
        } catch (err) {
          console.error('Application error', err);
          showMessage('Error submitting application. Try again later.', false);
          submitBtn.classList.remove('btn-disabled');
          submitBtn.disabled = false;
        }
      });
    })();

    // Member check: show/hide member-only content
    async function checkMembership() {
      const token = localStorage.getItem('apiToken');
      if (!token) return; // not logged in
      try {
        const res = await fetch('/api/me/', { headers: token ? { 'Authorization': 'Token ' + token } : {} });
        if (!res.ok) return;
        const data = await res.json();
        if (data.is_member) {
          // mark page as member
          document.body.classList.add('is-member');
        }
      } catch (err) {
        console.error('Membership check failed', err);
      }
    }
    checkMembership();
  </script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apply to join • Adventurers Guild</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="/config.js"></script>
  <script src="/cta.js" defer></script>
</head>
<body>
  <main class="container">
    <h1>Apply to join the Adventurers Guild</h1>
    <p>Please fill the form below and our admins will review your application.</p>
    <form id="application-page-form">
      <!-- Honeypot field to trap bots; keep it hidden from users -->
      <input type="text" name="hp_field" id="hp_field" style="display:none" tabindex="-1" autocomplete="off" />
      <input name="email" type="email" placeholder="Email" required />
      <input name="full_name" placeholder="Full name" />
      <label>Skills</label>
      <textarea name="skills" placeholder="List your skills"></textarea>
      <label>Qualities / availability</label>
      <textarea name="qualities" placeholder="Your qualities and availability"></textarea>
      <label>Why do you want to join?</label>
      <textarea name="additional_info" placeholder="Tell us why you'd be a good member"></textarea>
      <button type="submit" id="application-submit">Submit Application</button>
    </form>
    <p id="application-page-result"></p>
  </main>

  <script>
    (function(){
      const form = document.getElementById('application-page-form');
      const submitBtn = document.getElementById('application-submit');
      const resEl = document.getElementById('application-page-result');
      let cooldown = false;

      function showMessage(text, type) {
        resEl.textContent = '';
        resEl.className = 'form-message ' + (type === 'ok' ? 'success' : 'error');
        resEl.textContent = text;
      }

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        if (cooldown) return showMessage('Please wait before submitting another application.', 'error');
        const f = ev.target;
        // Basic client-side validation
        if (!f.email.value) return showMessage('Please enter an email.', 'error');
        submitBtn.classList.add('btn-disabled');
        submitBtn.disabled = true;
        const body = {
          email: f.email.value,
          full_name: f.full_name.value,
          hp_field: f.hp_field.value,
          skills: f.skills.value,
          qualities: f.qualities.value,
          additional_info: f.additional_info.value,
        };
        try {
            // If reCAPTCHA site key is configured, obtain a token and include it
            async function getRecaptchaToken(){
              try{
                if (!window.RECAPTCHA_SITE_KEY) return null;
                if (!window.grecaptchaScriptInjected){
                  const s = document.createElement('script');
                  s.src = 'https://www.google.com/recaptcha/api.js?render=' + window.RECAPTCHA_SITE_KEY;
                  document.head.appendChild(s);
                  window.grecaptchaScriptInjected = true;
                  await new Promise(r => s.onload = r);
                }
                if (window.grecaptcha){
                  return await window.grecaptcha.execute(window.RECAPTCHA_SITE_KEY, {action: 'application'});
                }
              }catch(e){
                return null;
              }
              return null;
            }

            const token = await getRecaptchaToken();
            if (token) body.recaptcha_token = token;

            const res = await fetch('/api/applications/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || res.statusText || 'Submission failed');
          }
          showMessage('Application submitted — we will review it and get back to you.', 'ok');
          f.reset();
          // client-side cooldown to avoid accidental reps
          cooldown = true;
          setTimeout(() => { cooldown = false; submitBtn.classList.remove('btn-disabled'); submitBtn.disabled = false; }, 30000);
        } catch (err) {
          console.error(err);
          showMessage('Error submitting application. Please try again later.', 'error');
          submitBtn.classList.remove('btn-disabled');
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
  <header class="guild-header">
    <h1>Apply to join the Adventurers Guild</h1>
    <nav class="main-nav">
      <a href="/">Guild Hall</a>
      <a href="/quests" class="btn-apply">Quest Board</a>
    </nav>
  </header>
  <main class="container">
